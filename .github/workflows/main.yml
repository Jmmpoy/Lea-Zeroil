name: Générer footer.html avec tous les fichiers

on:
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  generate-footer:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Générer footer.html avec version dynamique
        run: |
          VERSION=$(date +%Y%m%d%H%M%S)
          mkdir -p public/generated

          FOOTER="public/generated/footer.html"

          echo "<!-- Généré automatiquement : $VERSION -->" > $FOOTER

          # ===============================
          # Liens externes (inchangés)
          # ===============================
          echo '<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css">' >> $FOOTER
          echo '<script src="https://cdn.commoninja.com/sdk/latest/commonninja.js" defer></script>' >> $FOOTER
          echo '<div class="commonninja_component pid-0c54ac61-e503-4390-9055-f39e23383385"></div>' >> $FOOTER
          echo '<link rel="stylesheet" href="https://cdn.squarify.xyz/cart-slideout/styles.css">' >> $FOOTER
          echo '<script defer src="https://cdn.squarify.xyz/cart-slideout/index.js"></script>' >> $FOOTER
          echo '<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>' >> $FOOTER

          # ===============================
          # Fichiers internes versionnés
          # ===============================
          find public -type f \( -name "*.css" -o -name "*.js" \) \
          | grep -v "/generated/" \
          | sort \
          | while read -r filepath; do

            relative_path="${filepath#public}"

            if [[ "$filepath" == *.css ]]; then
              echo "<link rel=\"stylesheet\" href=\"${relative_path}?v=$VERSION\">" >> $FOOTER
            elif [[ "$filepath" == *.js ]]; then
              echo "<script src=\"${relative_path}?v=$VERSION\" defer></script>" >> $FOOTER
            fi

          done

      - name: Commit and push
        uses: EndBug/add-and-commit@v9
        with:
          add: 'public/generated/footer.html'
          message: 'Génération complète footer.html versionné'
          push: true